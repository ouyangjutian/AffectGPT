#!/bin/bash
#########################################################################
# MER-UniBench 9ä¸ªæ•°æ®é›† Emotion_Peak Frameç‰¹å¾æ‰¹é‡é¢„æå–è„šæœ¬
#########################################################################

echo "======================================================================="
echo "ğŸš€ MER-UniBench Frame Emotion_Peak Feature Extraction"
echo "======================================================================="
echo ""

# é…ç½®å‚æ•°
OUTPUT_ROOT="../preextracted_features"  # ç›¸å¯¹äºMER-UniBenchç›®å½•
MER_FACTORY_OUTPUT="/home/project/MER-Factory/output"
VISUAL_ENCODER="CLIP_VIT_LARGE"
N_FRMS=8
DEVICE="cuda:0"

# æ•°æ®é›†åˆ—è¡¨
DATASETS=(
    "cmumosei"
    "cmumosi"
    "iemocap"
    "meld"
    "mer2023"
    "mer2024"
    "ovmerdplus"
    "sims"
    "simsv2"
)

echo "ğŸ“Š å°†å¤„ç†ä»¥ä¸‹æ•°æ®é›†:"
for dataset in "${DATASETS[@]}"; do
    echo "  - $dataset"
done
echo ""

# æ£€æŸ¥MER-Factoryè¾“å‡ºç›®å½•
if [ ! -d "$MER_FACTORY_OUTPUT" ]; then
    echo "âŒ MER-Factory output directory not found: $MER_FACTORY_OUTPUT"
    echo "   emotion_peaké‡‡æ ·éœ€è¦MER-Factoryç”Ÿæˆçš„au_info"
    echo ""
    echo "è¯·å…ˆè¿è¡ŒMER-Factoryå¤„ç†è¿™äº›æ•°æ®é›†:"
    echo "  cd /home/project/MER-Factory"
    echo "  python main.py --dataset <dataset_name> --modality video"
    echo ""
    exit 1
fi

# æ£€æŸ¥å“ªäº›æ•°æ®é›†å·²æœ‰MER-Factoryè¾“å‡º
echo "ğŸ” æ£€æŸ¥MER-Factoryè¾“å‡º..."
for dataset in "${DATASETS[@]}"; do
    # æ ¹æ®æ•°æ®é›†åç§°æ˜ å°„MER-Factoryç›®å½•åï¼ˆå®é™…æ–‡ä»¶å¤¹åï¼‰
    case $dataset in
        "cmumosei") mer_dir="CMUMOSEI" ;;
        "cmumosi")  mer_dir="CMUMOSI" ;;
        "iemocap")  mer_dir="IEMOCAPFour" ;;
        "meld")     mer_dir="MELD" ;;
        "mer2023")  mer_dir="MER2023" ;;
        "mer2024")  mer_dir="MER2024" ;;
        "ovmerdplus") mer_dir="OVMERDPlus" ;;
        "sims")     mer_dir="SIMS" ;;
        "simsv2")   mer_dir="SIMSv2" ;;
        *)          mer_dir="$dataset" ;;
    esac
    
    if [ -d "$MER_FACTORY_OUTPUT/$mer_dir" ]; then
        sample_count=$(find "$MER_FACTORY_OUTPUT/$mer_dir" -name "*_au_analysis.json" 2>/dev/null | wc -l)
        echo "  âœ… $dataset: $sample_count ä¸ªæ ·æœ¬å·²å¤„ç†"
    else
        echo "  âš ï¸  $dataset: MER-Factoryè¾“å‡ºä¸å­˜åœ¨"
    fi
done
echo ""

# è¯¢é—®æ˜¯å¦ç»§ç»­
read -p "æ˜¯å¦ç»§ç»­æå–ç‰¹å¾? (y/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "å·²å–æ¶ˆ"
    exit 0
fi

# è¿è¡Œç‰¹å¾æå–
echo ""
echo "======================================================================="
echo "â³ å¼€å§‹æå–ç‰¹å¾..."
echo "======================================================================="
echo ""

START_TIME=$(date +%s)

python3 extract_frame_emotion_peak_batch.py \
    --datasets "${DATASETS[@]}" \
    --output-root "$OUTPUT_ROOT" \
    --mer-factory-output "$MER_FACTORY_OUTPUT" \
    --visual-encoder "$VISUAL_ENCODER" \
    --n-frms "$N_FRMS" \
    --device "$DEVICE"

END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
HOURS=$((ELAPSED / 3600))
MINUTES=$(((ELAPSED % 3600) / 60))
SECONDS=$((ELAPSED % 60))

echo ""
echo "======================================================================="
echo "âœ… æ‰¹é‡æå–å®Œæˆ!"
echo "======================================================================="
printf "â±ï¸  æ€»è€—æ—¶: %02d:%02d:%02d\n" $HOURS $MINUTES $SECONDS
echo ""

# æ£€æŸ¥ç”Ÿæˆçš„ç‰¹å¾æ–‡ä»¶
echo "ğŸ“Š ç‰¹å¾æ–‡ä»¶ç»Ÿè®¡:"
for dataset in "${DATASETS[@]}"; do
    feat_dir="$OUTPUT_ROOT/$dataset/frame_${VISUAL_ENCODER}_emotion_peak_${N_FRMS}frms"
    if [ -d "$feat_dir" ]; then
        count=$(ls "$feat_dir"/*.npy 2>/dev/null | wc -l)
        size=$(du -sh "$feat_dir" 2>/dev/null | cut -f1)
        echo "  - $dataset: $count ä¸ªæ–‡ä»¶, $size"
    fi
done
echo ""

echo "ğŸ’¡ ä½¿ç”¨æ–¹æ³•:"
echo "   åœ¨eval_configs/*.yamlä¸­é…ç½®:"
echo "   datasets:"
echo "     <dataset_name>:"
echo "       frame_sampling: 'emotion_peak'"
echo "       use_preextracted_features: True"
echo "       preextracted_root: './preextracted_features/<dataset_name>'"
echo ""
